#!/usr/bin/perl

use strict;
use warnings;
use POSIX qw/strftime/;

my $date =  strftime("%Y%m%d", localtime);

my $template_file = 'vt_template.tex';
open my $template_handle, '<', $template_file or die "$template_file: $!\n";
my @template_lines = <$template_handle>;
close $template_handle;

my $input_file = shift;
open my $input_handle, '<', $input_file or die "$input_file: $!\n";
my @input_lines = <$input_handle>;
map {$_ =~ s/\#/\\#/g} @input_lines;
close $input_handle;

my $output_file = "vt_$date.tex";
my $version = 0;
open my $output_handle, '>', $output_file or die "$output_file: $!\n";
print "printing to $output_file\n";
select($output_handle);

my $index = 0;
while($index < @template_lines and $template_lines[$index] !~ /begin{document}/){
  print $template_lines[$index++];
}
print $template_lines[$index++];
print "\n";
print '\maketitle', "\n";
print "\n";
print '\subsection*{Visiting Teaching Assignments}', "\n";
print '\begin{multicols}{4}', "\n";
print "\n";

my $input_index = 0;
while($input_index < @input_lines and $input_lines[$input_index] !~ /not currently assigned/i){
  # at this point we have a header row
  print $input_lines[$input_index++];
  print '\begin{itemize*}', "\n";
  while($input_index < @input_lines and $input_lines[$input_index] !~ /^\s*$/){
    print '\item ';
    print $input_lines[$input_index++];
  }
  while($input_index < @input_lines and $input_lines[$input_index] =~ /^\s*$/){
    $input_index++;
  }
  print '\end{itemize*}', "\n";
}
print '\end{multicols}', "\n";

print "\n";
print '\subsection*{Not Currently Assigned}', "\n";
print "\n";
print '\begin{multicols}{2}', "\n";
print '\begin{itemize*}', "\n";
while(++$input_index < @input_lines){
  if($input_lines[$input_index] !~ /^\s*$/){
    print '\item ';
    print $input_lines[$input_index++];
  }
}
print '\end{itemize*}', , "\n";
print '\end{multicols}', "\n";

while($index < @template_lines){
  print $template_lines[$index++];
}

close $output_handle;
